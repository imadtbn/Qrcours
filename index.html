<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“˜ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± - Ø§Ù„Ø£Ø³ØªØ§Ø° Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f4f7f9;
      padding: 20px;
      text-align: center;
    }
    header {
      background-color: #006233;
      color: white;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
    }
    #reader {
      margin: 20px auto;
      width: 320px;
      max-width: 90%;
    }
    #result, #counter-box {
      margin-top: 15px;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 95%;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background-color: #e0f2f1;
    }
    button {
      background-color: #006233;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      margin: 10px 5px;
      font-family: 'Cairo';
    }
  </style>
</head>
<body>

  <header>ğŸ“˜ Ø§Ù„Ø£Ø³ØªØ§Ø° Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ - Ù…Ø§Ø¯Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</header>

  <h3>ğŸ“¸ Ø§Ù…Ø³Ø­ Ø±Ù…Ø² QR Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
  <div id="reader"></div>
  <div id="result">âš™ï¸ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³Ø­...</div>

  <div id="counter-box">ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±: <span id="counter">0</span></div>

  <h4>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…:</h4>
  <table id="attendance-table">
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
        <th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
        <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      </tr>
    </thead>
    <tbody id="attendance-body"></tbody>
  </table>

  <button onclick="generatePDF()">ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± PDF</button>

  <audio id="success-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_5f52f8149d.mp3"></audio>

  <script>
    const scriptURL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec"; // ğŸ‘ˆ Ø¹Ø¯Ù„ Ù‡Ø°Ø§
    const scannedToday = new Set();
    const tableBody = document.getElementById("attendance-body");
    const counter = document.getElementById("counter");
    const resultDiv = document.getElementById("result");
    const successSound = document.getElementById("success-sound");

    function parseQRData(text) {
      const lines = text.split("\n");
      const data = {};
      lines.forEach(line => {
        const [key, value] = line.split(":");
        if (key && value) data[key.trim()] = value.trim();
      });
      return data;
    }

    function handleScan(text) {
      if (scannedToday.has(text)) {
        resultDiv.innerHTML = "<span style='color:orange;'>ğŸ” ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ù…Ø³Ø¨Ù‚Ù‹Ø§.</span>";
        return;
      }

      const data = parseQRData(text);
      const today = new Date().toLocaleDateString();

      if (!data["Ø§Ù„Ø§Ø³Ù…"] || !data["Ø§Ù„Ù…Ø³ØªÙˆÙ‰"] || !data["Ø§Ù„Ø´Ø¹Ø¨Ø©"]) {
        resultDiv.innerHTML = "<span style='color:red;'>âš ï¸ ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯</span>";
        return;
      }

      scannedToday.add(text);
      counter.textContent = scannedToday.size;
      resultDiv.innerHTML = `<span style='color:green;'>âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„: ${data["Ø§Ù„Ø§Ø³Ù…"]}</span>`;
      successSound.play();

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${data["Ø§Ù„Ø§Ø³Ù…"] || ""}</td>
        <td>${data["Ø§Ù„Ù…Ø³ØªÙˆÙ‰"] || ""}</td>
        <td>${data["Ø§Ù„Ø´Ø¹Ø¨Ø©"] || ""}</td>
        <td>${data["Ø§Ù„Ù‡Ø§ØªÙ"] || ""}</td>
        <td>${data["Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„"] || ""}</td>
        <td>${today}</td>
      `;
      tableBody.appendChild(row);

      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({
          "name": data["Ø§Ù„Ø§Ø³Ù…"],
          "level": data["Ø§Ù„Ù…Ø³ØªÙˆÙ‰"],
          "section": data["Ø§Ù„Ø´Ø¹Ø¨Ø©"],
          "phone": data["Ø§Ù„Ù‡Ø§ØªÙ"],
          "email": data["Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„"],
          "date": today
        })
      });
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¹ ØªØ£Ø«ÙŠØ±Ø§Øª
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        highlightScanRegion: true,
        highlightCodeOutline: true
      },
      (decodedText) => handleScan(decodedText),
      (errorMessage) => {}
    );

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const today = new Date().toLocaleDateString("ar-EG");

      doc.setFontSize(16);
      doc.text("ğŸ“˜ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±", 105, 15, { align: "center" });
      doc.setFontSize(12);
      doc.text(`ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today}`, 14, 25);

      const headers = ["Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ù…Ø³ØªÙˆÙ‰", "Ø§Ù„Ø´Ø¹Ø¨Ø©", "Ø§Ù„Ù‡Ø§ØªÙ", "Ø§Ù„Ø¨Ø±ÙŠØ¯", "Ø§Ù„ØªØ§Ø±ÙŠØ®"];
      const data = Array.from(document.querySelectorAll("#attendance-body tr")).map(tr =>
        Array.from(tr.children).map(td => td.textContent)
      );

      let y = 35;
      headers.forEach((h, i) => doc.text(h, 15 + i * 30, y));
      y += 10;

      data.forEach(row => {
        row.forEach((cell, i) => doc.text(cell, 15 + i * 30, y));
        y += 10;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });

      doc.save(`ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø­Ø¶ÙˆØ±_${today}.pdf`);
    }
  </script>
</body>
</html>
