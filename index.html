<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“˜ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± - Ø§Ù„Ø£Ø³ØªØ§Ø° Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Arial&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #e0f7e9;
      color: #1a1a1a;
      padding: 20px;
      text-align: center;
    }
    header {
      background-color: #2e7d32;
      color: white;
      padding: 15px;
      font-size: 22px;
      font-weight: bold;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      margin: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: 'Arial', sans-serif;
      font-size: 16px;
    }
    button {
      background-color: #43a047;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #2e7d32;
    }
    #qr-canvas {
      margin: 20px auto;
    }
    #form-fields {
      display: none;
      background-color: #c8e6c9;
      padding: 20px;
      border-radius: 10px;
      max-width: 450px;
      margin: auto;
    }
    #qr-actions {
      display: none;
      margin-top: 10px;
    }
    #scan-message {
      margin-top: 10px;
      font-size: 18px;
      color: #333;
    }
  </style>
</head>
<body>

<header>ğŸ“˜ Ø§Ù„Ø£Ø³ØªØ§Ø° Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ - Ù…Ø§Ø¯Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</header>

<button onclick="toggleForm()">âœï¸ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯</button>

<div id="form-fields">
  <input type="text" id="fullname" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"><br>
  <input type="text" id="level" placeholder="Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"><br>
  <input type="text" id="section" placeholder="Ø§Ù„Ø´Ø¹Ø¨Ø©"><br>
  <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"><br>
  <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"><br>
  <button onclick="generateQR()">ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯</button>
  <button onclick="resetFields()">ğŸ§¹ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</button>
</div>

<div id="qr-canvas"></div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) -->
<div id="qr-actions">
  <button onclick="saveQR()">ğŸ’¾ Ø­ÙØ¸</button>
  <button onclick="sendEmail()">âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
</div>

<!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙ‚Ø§Ø±Ø¦ QR -->
<div id="reader" style="width:300px; margin:auto;"></div>
<div id="scan-message">âš™ï¸ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³Ø­...</div>

<audio id="success-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_5f52f8149d.mp3"></audio>

<script>
  let qrScanner;
  let scannedToday = new Set();
  let duplicateCount = 0;

  function toggleForm() {
    const form = document.getElementById("form-fields");
    form.style.display = form.style.display === "none" ? "block" : "none";
  }

  function generateQR() {
    const name = document.getElementById("fullname").value.trim();
    const level = document.getElementById("level").value.trim();
    const section = document.getElementById("section").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const email = document.getElementById("email").value.trim();

    if (!name || !level || !section || !phone || !email) {
      alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
      return;
    }

    const content = `Ø§Ù„Ø§Ø³Ù…: ${name}\nØ§Ù„Ù…Ø³ØªÙˆÙ‰: ${level}\nØ§Ù„Ø´Ø¹Ø¨Ø©: ${section}\nØ§Ù„Ù‡Ø§ØªÙ: ${phone}\nØ§Ù„Ø¥ÙŠÙ…ÙŠÙ„: ${email}`;
    const qrCanvas = document.getElementById("qr-canvas");
    qrCanvas.innerHTML = "";
    QRCode.toCanvas(document.createElement('canvas'), content, function (error, canvas) {
      if (!error) {
        qrCanvas.appendChild(canvas);
        document.getElementById("qr-actions").style.display = "block";
      }
    });
  }

  function saveQR() {
    const canvas = document.querySelector("#qr-canvas canvas");
    if (!canvas) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹.");
    const name = document.getElementById("fullname").value.trim();
    const link = document.createElement("a");
    link.download = name + ".png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  }

  function sendEmail() {
    const name = document.getElementById("fullname").value.trim();
    const level = document.getElementById("level").value.trim();
    const section = document.getElementById("section").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const email = document.getElementById("email").value.trim();

    const body = `Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„: ${name}%0AØ§Ù„Ù…Ø³ØªÙˆÙ‰: ${level}%0AØ§Ù„Ø´Ø¹Ø¨Ø©: ${section}%0AØ§Ù„Ù‡Ø§ØªÙ: ${phone}%0AØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${email}`;
    window.location.href = `mailto:${email}?subject=Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨&body=${body}`;
  }

  function resetFields() {
    document.getElementById("fullname").value = "";
    document.getElementById("level").value = "";
    document.getElementById("section").value = "";
    document.getElementById("phone").value = "";
    document.getElementById("email").value = "";
    document.getElementById("qr-canvas").innerHTML = "";
    document.getElementById("qr-actions").style.display = "none";
  }

  function startCamera() {
    qrScanner = new Html5Qrcode("reader");
    qrScanner.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        highlightScanRegion: true,
        highlightCodeOutline: true
      },
      (decodedText) => {
        const today = new Date().toLocaleDateString();
        const messageDiv = document.getElementById("scan-message");

        if (scannedToday.has(decodedText + today)) {
          duplicateCount++;
          messageDiv.innerHTML =
            "âš ï¸ ØªÙ… Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø§Ù„ÙŠÙˆÙ….<br>ğŸš« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©: " + duplicateCount;
          return;
        }

        scannedToday.add(decodedText + today);
        document.getElementById("success-sound").play();
        messageDiv.innerHTML = "âœ… ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­:<br>" + decodedText.replace(/\n/g, "<br>");

        const data = {};
        decodedText.split("\n").forEach(line => {
          const [key, value] = line.split(":");
          if (key && value) data[key.trim()] = value.trim();
        });

        fetch("https://script.google.com/macros/s/AKfycbxhmZLBZN1wjpRCRXtw4KBp17EEyLYD0rbmeSvEtq8WdlEG61aoR36Wj5BMZ5qBv7Jf8A/exec", {
          method: 'POST',
          body: new URLSearchParams({
            name: data["Ø§Ù„Ø§Ø³Ù…"] || "",
            level: data["Ø§Ù„Ù…Ø³ØªÙˆÙ‰"] || "",
            section: data["Ø§Ù„Ø´Ø¹Ø¨Ø©"] || "",
            phone: data["Ø§Ù„Ù‡Ø§ØªÙ"] || "",
            email: data["Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„"] || "",
            date: today
          })
        });
      },
      (errorMessage) => {}
    );
  }

  // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  window.onload = startCamera;
</script>

</body>
</html>
