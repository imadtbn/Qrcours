<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>📘 تسجيل الحضور - الأستاذ محمد محمد</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f4f7f9;
      padding: 20px;
      text-align: center;
    }
    header {
      background-color: #006233;
      color: white;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
    }
    #reader {
      margin: 20px auto;
      width: 320px;
      max-width: 90%;
    }
    #result, #counter-box {
      margin-top: 15px;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 95%;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background-color: #e0f2f1;
    }
    button {
      background-color: #006233;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      margin: 10px 5px;
      font-family: 'Cairo';
    }
  </style>
</head>
<body>

  <header>📘 الأستاذ محمد محمد - مادة الرياضيات</header>

  <h3>📸 امسح رمز QR لتسجيل الحضور</h3>
  <div id="reader"></div>
  <div id="result">⚙️ بانتظار المسح...</div>

  <div id="counter-box">📊 عدد الحضور: <span id="counter">0</span></div>

  <h4>📋 قائمة الحضور اليوم:</h4>
  <table id="attendance-table">
    <thead>
      <tr>
        <th>الاسم الكامل</th>
        <th>المستوى</th>
        <th>الشعبة</th>
        <th>الهاتف</th>
        <th>البريد</th>
        <th>التاريخ</th>
      </tr>
    </thead>
    <tbody id="attendance-body"></tbody>
  </table>

  <button onclick="generatePDF()">📄 إنشاء تقرير PDF</button>

  <audio id="success-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_5f52f8149d.mp3"></audio>

  <script>
    const scriptURL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec"; // 👈 عدل هذا
    const scannedToday = new Set();
    const tableBody = document.getElementById("attendance-body");
    const counter = document.getElementById("counter");
    const resultDiv = document.getElementById("result");
    const successSound = document.getElementById("success-sound");

    function parseQRData(text) {
      const lines = text.split("\n");
      const data = {};
      lines.forEach(line => {
        const [key, value] = line.split(":");
        if (key && value) data[key.trim()] = value.trim();
      });
      return data;
    }

    function handleScan(text) {
      if (scannedToday.has(text)) {
        resultDiv.innerHTML = "<span style='color:orange;'>🔁 تم تسجيل هذا الشخص مسبقًا.</span>";
        return;
      }

      const data = parseQRData(text);
      const today = new Date().toLocaleDateString();

      if (!data["الاسم"] || !data["المستوى"] || !data["الشعبة"]) {
        resultDiv.innerHTML = "<span style='color:red;'>⚠️ تنسيق غير صحيح في الكود</span>";
        return;
      }

      scannedToday.add(text);
      counter.textContent = scannedToday.size;
      resultDiv.innerHTML = `<span style='color:green;'>✅ تم تسجيل: ${data["الاسم"]}</span>`;
      successSound.play();

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${data["الاسم"] || ""}</td>
        <td>${data["المستوى"] || ""}</td>
        <td>${data["الشعبة"] || ""}</td>
        <td>${data["الهاتف"] || ""}</td>
        <td>${data["الإيميل"] || ""}</td>
        <td>${today}</td>
      `;
      tableBody.appendChild(row);

      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({
          "name": data["الاسم"],
          "level": data["المستوى"],
          "section": data["الشعبة"],
          "phone": data["الهاتف"],
          "email": data["الإيميل"],
          "date": today
        })
      });
    }

    // إعداد الكاميرا مع تأثيرات
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        highlightScanRegion: true,
        highlightCodeOutline: true
      },
      (decodedText) => handleScan(decodedText),
      (errorMessage) => {}
    );

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const today = new Date().toLocaleDateString("ar-EG");

      doc.setFontSize(16);
      doc.text("📘 تقرير الحضور", 105, 15, { align: "center" });
      doc.setFontSize(12);
      doc.text(`📅 التاريخ: ${today}`, 14, 25);

      const headers = ["الاسم", "المستوى", "الشعبة", "الهاتف", "البريد", "التاريخ"];
      const data = Array.from(document.querySelectorAll("#attendance-body tr")).map(tr =>
        Array.from(tr.children).map(td => td.textContent)
      );

      let y = 35;
      headers.forEach((h, i) => doc.text(h, 15 + i * 30, y));
      y += 10;

      data.forEach(row => {
        row.forEach((cell, i) => doc.text(cell, 15 + i * 30, y));
        y += 10;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });

      doc.save(`تقرير_الحضور_${today}.pdf`);
    }
  </script>
</body>
</html>
